{%- assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ',' -%}
{%- assign color_white_label = 'general.label.white' | t | downcase -%}
{%- assign quick_buy_icon_name = 'quick-buy-' | append: settings.cart_icon | replace: '_', '-' -%}

{%- if product.url contains '?' -%}
  {%- assign product_url_contains_query = true -%}
{%- else -%}
  {%- assign product_url_contains_query = false -%}
{%- endif -%}

<product-item class="product-item product-item--custom-wholesale {% unless product.available %}product-item--sold-out{% endunless %} product-select--{{ product.id }}" {% if reveal %}reveal{% endif %}>

  <div class="product-item__general-product">
  
    {%- capture product_labels -%}
      {%- for tag in product.tags -%}
        {%- if tag contains '__label' -%}
          <span class="label label--custom{% if tag contains '__label2' %}2{% endif %}">{{ tag | split: ':' | last }}</span>
        {%- endif -%}
      {%- endfor -%}


      {%- assign is_b2b = false -%}
      {%- if customer and customer.b2b -%}
        {%- assign is_b2b = true -%}
      {%- endif -%}
      
      {%- assign has_disabled_tag = false -%}
      {%- if product.tags contains 'DISABLED: PRODUCT OUT OF STOCK B2B' -%}
        {%- assign has_disabled_tag = true -%}
      {%- endif -%}

       {%- assign is_sold_out = false -%}
        {%- if product.available == false -%}
          {%- assign is_sold_out = true -%}
        {%- elsif has_disabled_tag and is_b2b == false -%}
          {%- assign is_sold_out = true -%}
        {%- endif -%}

      {%- if product.available and customer.b2b? -%}
        {%- assign is_sold_out = false -%}
      {%- endif -%}
      
      {% if is_sold_out %}
        <span class="label label--subdued">{{ 'collection.product.sold_out' | t }}</span>
      {% endif %}

      

  
      {%- assign cheapest_variant = product.variants | sort: 'price' | first -%}
  
      {%- if settings.show_discount and product.available and product.price < product.compare_at_price and cheapest_variant.compare_at_price != blank -%}
        {%- if settings.discount_mode == 'percentage' -%}
          {%- assign savings = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round | append: '%' -%}
        {%- else -%}
          {%- capture savings -%}{{ product.compare_at_price | minus: product.price | money }}{%- endcapture -%}
        {%- endif -%}
  
        <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
      {%- endif -%}
    {%- endcapture -%}



    {% if customer.b2b? %}
      {% if product.available %}
        <div class="gw-add-to-wishlist-product-card-placeholder gw-add-to-wishlist-product-card-placeholder--global" data-gw-product-id="{{ product.id }}" data-gw-variant-id="{{ product.selected_or_first_available_variant.id }}"></div>
      {% endif %}
    {% endif %}


    
    <div class="product-item__image-wrapper {% if settings.show_secondary_image and product.media.size > 1 and hide_secondary_image != true %}product-item__image-wrapper--multiple{% endif %}">
      {% if collection.title != "BLACK FRIDAY DEALS" %}
        {%- if product_labels != blank and reduced_content != true -%}
          <div class="product-item__label-list label-list">
            {{- product_labels -}}
          </div>
        {%- endif -%}
      {% endif %}
      
  
      <a href="{{ product.url | within: collection }}" class="product-item__aspect-ratio aspect-ratio {% if settings.product_image_size != 'natural' %}aspect-ratio--{{ settings.product_image_size }}{% endif %}" style="padding-bottom: {{ 100.0 | divided_by: product.featured_media.preview_image.aspect_ratio }}%; --aspect-ratio: {{ product.featured_media.preview_image.aspect_ratio }}">
        <img class="product-item__primary-image" loading="lazy" data-media-id="{{ product.featured_media.id | escape }}" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: product.featured_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
  
        {%- if settings.product_color_display == 'swatch' -%}
          {%- for color_label in color_label_list -%}
            {%- if product.options_by_name[color_label] != blank -%}
  			      {%- for color_option in product.options_by_name[color_label].values -%}
         		    {%- for variant in product.variants -%}
        			    {%- if variant.options contains color_option -%}
            		    {%- unless variant.featured_media == product.featured_media -%}
              		    <img class="product-item__primary-image" hidden data-media-id="{{ variant.featured_media.id | escape }}" loading="lazy" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: variant.featured_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
        				      {% break %}
            		    {%- endunless -%}
        			    {%- endif -%}
                {%- endfor -%}
  	          {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
  
        {%- if settings.show_secondary_image and product.media.size > 1 and hide_secondary_image != true -%}
          {%- assign next_media = product.media[product.featured_media.position] | default: product.media[1] -%}
          <img class="product-item__secondary-image" loading="lazy" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: next_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
        {%- endif -%}
      </a>
  
      {%- if request.page_type != 'password' and settings.product_add_to_cart and product.available and reduced_content != true and show_cta != true -%}
        {%- if product.variants.size == 1 -%}
          {%- capture form_id -%}product_form_{{ section.id }}_{{ block.id }}_{{ product.id }}_{% increment product_form_index %}{%- endcapture -%}
          {%- form 'product', product, is: 'product-form', id: form_id, class: 'product-item__quick-form' -%}
            <input type="hidden" name="quantity" value="1">
            <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
            <button is="loader-button" type="submit" class="button button--outline button--text button--full {% if section.settings.desktop_products_per_row >= 5 %}button--small{% endif %} hidden-touch">{{ 'collection.product.add_to_cart_short' | t }}</button>
            <button type="submit" class="product-item__quick-buy-button hidden-no-touch">
              <span class="visually-hidden">{{ 'collection.product.add_to_cart_short' | t }}</span>
              {%- render 'icon' with quick_buy_icon_name -%}
            </button>
          {%- endform -%}
        {%- else -%}
          {%- comment -%}
          IMPLEMENTATION NOTE: Depending on the device we show a different icon or open a different mode (either popover or drawer)
          {%- endcomment -%}
  
          <div class="product-item__quick-form">
            <button is="toggle-button" loader aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" aria-expanded="false" class="button button--outline button--text button--full {% if section.settings.desktop_products_per_row >= 5 %}button--small{% endif %} hidden-touch hidden-phone">{{ 'collection.product.quick_view' | t }}</button>
            <button is="toggle-button" aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" aria-expanded="false" class="product-item__quick-buy-button hidden-no-touch hidden-phone">
              <span class="visually-hidden">{{ 'collection.product.quick_view' | t }}</span>
              {%- render 'icon' with quick_buy_icon_name -%}
            </button>
  
            <button is="toggle-button" aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-popover" aria-expanded="false" class="product-item__quick-buy-button hidden-tablet-and-up">
              <span class="visually-hidden">{{ 'collection.product.quick_view' | t }}</span>
              {%- render 'icon' with quick_buy_icon_name -%}
            </button>
          </div>
  
          <quick-buy-popover id="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-popover" href="{{ product.url }}{% if product_url_contains_query %}&{% else %}?{% endif %}view=quick-buy-popover" class="popover popover--quick-buy hidden-tablet-and-up"></quick-buy-popover>
          <quick-buy-drawer id="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" href="{{ product.url }}{% if product_url_contains_query %}&{% else %}?{% endif %}view=quick-buy-drawer" class="drawer drawer--large drawer--quick-buy hidden-phone"></quick-buy-drawer>
        {%- endif -%}
      {%- endif -%}
    </div>
  
    <div class="product-item__info {% if show_cta %}product-item__info--with-button{% endif %} {% if reduced_font_size %}text--small{% endif %}
      {% if product.metafields["custom_fields"]["product_description"] != blank %}
        product-item__info-with-description
      {% endif %}  
    ">
  
  
      
      <div class="product-item-meta">
  
        {% unless customer.b2b? %}
          {% if settings.active_campaign == true %}
    
            {% if product.tags contains settings.tag_campaign %}
              {% if settings.label_campaign != '' %}
                <div class="container-labels-home">
                  <p>{{ settings.label_campaign }}</p>
                </div>
              {% endif %}
            {% endif %}
      
          {% endif %}
        {% endunless %}
  
  
        
        {%- if settings.show_vendor -%}
          {%- assign vendor_handle = product.vendor | handle -%}
          {%- assign collection_for_vendor = collections[vendor_handle] -%}
  
          {%- unless collection_for_vendor.empty? -%}
            <a class="product-item-meta__vendor heading heading--xsmall" href="{{ product.url }}">
              {% if product.selected_or_first_available_variant.sku %}
                SKU: {{ product.selected_or_first_available_variant.sku }}
              {% else %}
                SKU: {{ product.vendor }}
              {% endif %}
            </a>
          {%- else -%}
            <a class="product-item-meta__vendor heading heading--xsmall" href="{{ product.url }}">
              {% if product.selected_or_first_available_variant.sku %}
                SKU: {{ product.selected_or_first_available_variant.sku }}
              {% else %}
                SKU: {{ product.vendor }}
              {% endif %}
            </a>
          {%- endunless -%}
        {%- endif -%}  
  
  
        <!-- Start of Judge.me code --> 
          <div class='jdgm-widget jdgm-preview-badge' data-id='{{ product.id }}'> 
            {{ product.metafields.judgeme.badge }} 
          </div> 
        <!-- End of Judge.me code -->
  
  
  
        <a href="{{ product.url }}" class="product-item-meta__title">{{ product.title }}</a>
  
  
  
  
        {%- if settings.product_color_display != 'hide' and reduced_content != true -%}
          {%- for color_label in color_label_list -%}
            {%- if product.options_by_name[color_label] != blank -%}
              {%- assign product_option = product.options_by_name[color_label] -%}
  
              {%- case settings.product_color_display -%}
                {%- when 'count' -%}
                  <p class="product-item-meta__color-count text--small text--subdued">{{- 'collection.product.available_colors_count' | t: count: product_option.values.size -}}</p>
  
                {%- when 'swatch' -%}
                  <div class="product-item-meta__swatch-list color-swatch-list color-swatch-list--mini">
                    {%- assign variant_option = 'option' | append: product_option.position -%}
                    {%- assign color_swatch_config = settings.color_swatch_config | newline_to_br | split: '<br />' -%}
  
                    {%- capture color_name -%}{{ section.id }}-{{ block.id }}-{{ product.id }}{%- endcapture -%}
  
                    {%- for value in product_option.values -%}
                      {%- capture color_id -%}{{ color_name }}-{{ forloop.index }}{%- endcapture -%}
                      {%- assign color_value_downcase = value | downcase -%}
                      {%- assign variant_for_value = product.variants | where: variant_option, value | first -%}
  
                      <div class="color-swatch {% if color_white_label == color_value_downcase %}color-swatch--white{% endif %}">
                        <input class="color-swatch__radio visually-hidden" type="radio" name="{{ color_name }}" id="{{ color_id }}" value="{{ value | escape }}" {% if product_option.selected_value == value %}checked="checked"{% endif %} data-variant-id="{{ variant_for_value.id }}" {% if variant_for_value.featured_media %}data-variant-featured-media="{{ variant_for_value.featured_media.id }}"{% endif %}>
                        {% comment %} <label class="color-swatch__item" for="{{ color_id }}" style="{% render 'color-swatch-style', color_swatch_config: color_swatch_config, value: value, imageSrc: variant_for_value.image | remove: 'files/' | file_url %}"> {% endcomment %}

                        {% assign image_value = variant_for_value.image | image_url %}

                        {% comment %} {% if image_value contains '/products/' %}
                          {% assign image_value = variant_for_value.image %}
                        {% else %}
                          {% assign image_value = image_value | remove: 'files/' | file_url %}
                        {% endif %} {% endcomment %}

                        <label class="color-swatch__item" for="{{ color_id }}" style="background-image: url({{ image_value  }})">
                          <span class="visually-hidden">{{ value }}</span>
                        </label>
                      </div>
                    {%- endfor -%}
                  </div>
              {%- endcase -%}
  
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
  
  
  

        {% if product.metafields.custom.channel or
              product.metafields.custom.voltmeter or
              product.metafields.custom.custom_field_1 or 
              product.metafields.custom.custom_field_2 or
              product.metafields.custom.color_name
        %}

          <div class="variants-metafiels">
  
            {% if product.metafields.custom.channel_variants %}
              {% render 'channel-variant__collection', product: product %}
            {% endif %}
          
            {% if product.metafields.custom.voltmeter_variants %}
              {% render 'voltmeter-variant__collection', product: product %}
            {% endif %}
          
            {% if product.metafields.custom.custom_field_1_variants %}
              {% render 'custom-one-variant__collection', product: product %}
            {% endif %}
          
            {% if product.metafields.custom.custom_field_2_variants %}
              {% render 'custom-two-variant__collection', product: product %}
            {% endif %}
    
            {% if product.metafields.custom.color_variants %}
              {% render 'color-variant__collection', product: product %}
            {% endif %}
  
          </div>

        {% endif %}

        
          
  
  
  
  
      {% if customer.b2b? %}  
  
        <div class="container-prices-b2b" data-url="{{ product.handle }}">
          <p class="wholesale">Your Price:<span>{{ product.price | money }}</span></p>

          {% if product.compare_at_price or product.selected_or_first_available_variant.metafields.custom.b2b_dealer_price %}
            {% if product.selected_or_first_available_variant.metafields.custom.b2b_dealer_price %}
              <p class="dealer">Dealer:<span>{{ product.selected_or_first_available_variant.metafields.custom.b2b_dealer_price }}</span></p>
            {% else %}
              <p class="dealer">Dealer:<span>{{ product.compare_at_price | money }}</span></p>
            {% endif %}
          {% endif %}
          
          <p class="retail">Retail:<span></span></p>
        </div>
  
      {% endif %}
  
  
      
  
  
  
  
      {% if settings.active_campaign == true %}
  
        {% assign discount = 100 | minus: settings.campaign_discount_crossline %}
        {% assign FinalDiscount = discount | divided_by: 100.0 %}
        {% assign crossline = product.price | times: FinalDiscount %}
        {% assign label = settings.campaign_discount_crossline | append: "% OFF"  %}

        {% if collection.title == "BLACK FRIDAY DEALS" %}
            {% assign doubled_value = settings.campaign_discount_crossline | times: 2 %}
            {% assign label = doubled_value | append: "% OFF" %}
        {% endif %}
  
        {% if product.tags contains settings.tag_campaign %}
          <div class="product-item-meta__price-list-container product-item-meta__price-list-container--campaign">
            <div class="price-list price-list--centered">
              <span class="label">{{ label }}</span>
              <span class="price-real">{{ crossline | money }}</span>

              {% if product.compare_at_price > product.price %}
                <span class="price-crossline">{{ product.compare_at_price | money }}</span>
              {% else %}
                <span class="price-crossline">{{ product.price | money }}</span>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="product-item-meta__price-list-container">
            <div class="price-list price-list--centered">
              
              {%- if product.price_varies and product.compare_at_price -%}
                {%- assign cheapest_variant = product.variants | sort: 'price' | first -%}
    
                {%- capture price_min -%}
                  {%- if settings.currency_code_enabled -%}
                    {{- cheapest_variant.price | money_with_currency -}}
                  {%- else -%}
                    {{- cheapest_variant.price | money -}}
                  {%- endif -%}
                {%- endcapture -%}
    
                {%- if cheapest_variant.price < cheapest_variant.compare_at_price -%}
                  <span class="price price--highlight">
                    <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                    {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                  </span>
    
                  <span class="price price--compare">
                    <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
    
                    {%- if settings.currency_code_enabled -%}
                      {{- cheapest_variant.compare_at_price | money_with_currency -}}
                    {%- else -%}
                      {{- cheapest_variant.compare_at_price | money -}}
                    {%- endif -%}
                  </span>
                {%- else -%}
                  <span class="price">
                    <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                    {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                  </span>
                {%- endif -%}
              {%- elsif product.price < product.compare_at_price -%}
                <span class="price price--highlight">
                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
    
                  {%- if settings.currency_code_enabled -%}
                    {{- product.price | money_with_currency -}}
                  {%- else -%}
                    {{- product.price | money -}}
                  {%- endif -%}
                </span>
    
                <span class="price price--compare">
                  <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                  {%- if settings.currency_code_enabled -%}
                    {{- product.compare_at_price | money_with_currency -}}
                  {%- else -%}
                    {{- product.compare_at_price | money -}}
                  {%- endif -%}
                </span>
              {%- elsif product.price_varies -%}
                {%- capture price_min -%}
                  {%- if settings.currency_code_enabled -%}
                    {{ product.price_min | money_with_currency }}
                  {%- else -%}
                    {{ product.price_min | money }}
                  {%- endif -%}
                {%- endcapture -%}
    
                {%- capture price_max -%}
                  {%- if settings.currency_code_enabled -%}
                    {{- product.price_max | money_with_currency -}}
                  {%- else -%}
                    {{- product.price_max | money -}}
                  {%- endif -%}
                {%- endcapture -%}
    
                <span class="price">
                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                  {{- 'collection.product.from_price_html' | t: price_min: price_min, price_max: price_max -}}
                </span>
              {%- else -%}
                <span class="price">
                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
    
                  {%- if settings.currency_code_enabled -%}
                    {{- product.price | money_with_currency -}}
                  {%- else -%}
                    {{- product.price | money -}}
                  {%- endif -%}
                </span>
              {%- endif -%}
    
              {%- if product.selected_or_first_available_variant.unit_price_measurement -%}
                <div class="price price--block text--xsmall text--subdued">
                  <div class="unit-price-measurement">
                    <span class="unit-price-measurement__price">{{ product.selected_or_first_available_variant.unit_price | money }}</span>
                    <span class="unit-price-measurement__separator">/</span>
    
                    {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                      <span class="unit-price-measurement__reference-value">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}</span>
                    {%- endif -%}
    
                    <span class="unit-price-measurement__reference-unit">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}</span>
                  </div>
                </div>
              {%- endif -%}
            </div>
          </div>
        {% endif %}
        
      {% else %}
        <div class="product-item-meta__price-list-container">
          <div class="price-list price-list--centered">
            
            {%- if product.price_varies and product.compare_at_price -%}
              {%- assign cheapest_variant = product.variants | sort: 'price' | first -%}
  
              {%- capture price_min -%}
                {%- if settings.currency_code_enabled -%}
                  {{- cheapest_variant.price | money_with_currency -}}
                {%- else -%}
                  {{- cheapest_variant.price | money -}}
                {%- endif -%}
              {%- endcapture -%}
  
              {%- if cheapest_variant.price < cheapest_variant.compare_at_price -%}
                <span class="price price--highlight">
                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                  {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                </span>
  
                <span class="price price--compare">
                  <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
  
                  {%- if settings.currency_code_enabled -%}
                    {{- cheapest_variant.compare_at_price | money_with_currency -}}
                  {%- else -%}
                    {{- cheapest_variant.compare_at_price | money -}}
                  {%- endif -%}
                </span>
              {%- else -%}
                <span class="price">
                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                  {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                </span>
              {%- endif -%}
            {%- elsif product.price < product.compare_at_price -%}
              <span class="price price--highlight">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
  
                {%- if settings.currency_code_enabled -%}
                  {{- product.price | money_with_currency -}}
                {%- else -%}
                  {{- product.price | money -}}
                {%- endif -%}
              </span>
  
              <span class="price price--compare">
                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                {%- if settings.currency_code_enabled -%}
                  {{- product.compare_at_price | money_with_currency -}}
                {%- else -%}
                  {{- product.compare_at_price | money -}}
                {%- endif -%}
              </span>
            {%- elsif product.price_varies -%}
              {%- capture price_min -%}
                {%- if settings.currency_code_enabled -%}
                  {{ product.price_min | money_with_currency }}
                {%- else -%}
                  {{ product.price_min | money }}
                {%- endif -%}
              {%- endcapture -%}
  
              {%- capture price_max -%}
                {%- if settings.currency_code_enabled -%}
                  {{- product.price_max | money_with_currency -}}
                {%- else -%}
                  {{- product.price_max | money -}}
                {%- endif -%}
              {%- endcapture -%}
  
              <span class="price">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- 'collection.product.from_price_html' | t: price_min: price_min, price_max: price_max -}}
              </span>
            {%- else -%}
              <span class="price">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
  
                {%- if settings.currency_code_enabled -%}
                  {{- product.price | money_with_currency -}}
                {%- else -%}
                  {{- product.price | money -}}
                {%- endif -%}
              </span>
            {%- endif -%}
  
            {%- if product.selected_or_first_available_variant.unit_price_measurement -%}
              <div class="price price--block text--xsmall text--subdued">
                <div class="unit-price-measurement">
                  <span class="unit-price-measurement__price">{{ product.selected_or_first_available_variant.unit_price | money }}</span>
                  <span class="unit-price-measurement__separator">/</span>
  
                  {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                    <span class="unit-price-measurement__reference-value">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}</span>
                  {%- endif -%}
  
                  <span class="unit-price-measurement__reference-unit">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}</span>
                </div>
              </div>
            {%- endif -%}
          </div>
        </div>
      {% endif %}


  
        {%- if settings.show_product_rating and reduced_content != true -%}
          <a class="product-item-meta__reviews-badge text--small" href="{{ product.url }}">
            {%- render 'product-rating', product: product -%}
          </a>
        {%- endif -%}


        {% if product.metafields["custom_fields"]["product_description"] != blank %}
          <div class="custom-field custom-field__product-description custom-field__type--multi-line-text-field custom-field--mobile">
            <div class="custom-field--value">
              {{ product.metafields["custom_fields"]["product_description"] }}
            </div>
          </div>
        {% endif %}


        {% assign total_inventory = 0 %}
        {% for variant in product.variants %}
          {% if variant.inventory_policy == "continue" %}
            {% assign total_inventory = total_inventory | plus: 10000 %}
          {% else %}
            {% assign total_inventory = total_inventory | plus: variant.inventory_quantity %}
          {% endif %}
        {% endfor %}
        {% if total_inventory == 0 %}
          {% assign total_inventory = 1 %}
        {% endif %}


        {%- assign is_b2b_button = false -%}
        {%- if customer and customer.b2b -%}
          {%- assign is_b2b_button = true -%}
        {%- endif -%}
        
        {%- assign has_disabled_tag_button = false -%}
        {%- if product.tags contains 'DISABLED: PRODUCT OUT OF STOCK B2B' -%}
          {%- assign has_disabled_tag_button = true -%}
        {%- endif -%}
        
        {%- assign is_sold_out_button = false -%}
        {%- if product.available == false -%}
          {%- assign is_sold_out_button = true -%}
        {%- elsif has_disabled_tag_button and is_b2b_button == false -%}
          {%- assign is_sold_out_button = true -%}
        {%- endif -%}

        {%- if product.available and customer.b2b? -%}
          {%- assign is_sold_out_button = false -%}
        {%- endif -%}

        
        <div class="cta-buttons-eject">

          {% unless product.tags contains 'PACKAGES MADE FOR YOU' %}
            <div class="number-input">
              <button class="decrease" type="button" {% if is_sold_out_button %}disabled{% endif %}>-</button>
              <input class="number-input-field" type="number" min="1" {% if is_sold_out_button %}max="1"{% else %}max="{{ total_inventory }}"{% endif %} value="1" {% if is_sold_out_button %}readonly{% endif %}/>
              <button class="increase" type="button" {% if is_sold_out_button %}disabled{% endif %}>+</button>
            </div>
          {% endunless %}

          {% if is_sold_out_button %}
            <button disabled class="btn btn--sold-out btn--sold-out-uppercase">{{ 'collection.product.sold_out' | t }}</button>
          {% else %}

            {% if product.tags contains 'PACKAGES MADE FOR YOU' %}
              <button class="btn btn--add-to-cart btn--add-to-cart--redirect-product" onclick="window.location.href='{{ product.url }}'">BUILD YOUR SYSTEM</button>
            {% else %}  

              {% if product.has_only_default_variant %}
                <button class="btn btn--add-to-cart" onclick="addToCartCollection({{ product.selected_or_first_available_variant.id }})">{{ 'collection.product.add_to_cart_main' | t }}</button>
              {% else %}
                <a
                  href="{{ product.url }}"
                  class="link-btn"
                >
                  Select Options
                </a>
              {% endif %}
              
             
            {% endif %}

          
          {% endif %}
        </div>


        
 
      </div>


      {% if product.metafields["custom_fields"]["product_description"] != blank %}
          <div class="custom-field custom-field__product-description custom-field__type--multi-line-text-field custom-field--desktop">
            <div class="custom-field--value">
              {{ product.metafields["custom_fields"]["product_description"] }}
            </div>
          </div>
        {% endif %}
  
      {% comment %}
        {%- if product.available and reduced_content or show_cta -%}
          <div class="product-item__cta-wrapper">
            {%- if product.variants.size == 1 -%}
              {%- capture form_id -%}product_form_{{ section.id }}_{{ block.id }}_{{ product.id }}_{% increment product_form_index %}{%- endcapture -%}
              {%- form 'product', product, is: 'product-form', id: form_id -%}
                <input type="hidden" name="quantity" value="1">
                <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                <button type="submit" {% if show_cta %}is="loader-button"{% endif %} class="{% if reduced_content %}product-item__link link text--subdued{% else %}product-item__cta button button--primary{% endif %}">{{ 'collection.product.add_to_cart_short' | t }}</button>
              {%- endform -%}
            {%- else -%}
              <button type="button" {% if show_cta %}loader{% endif %} is="toggle-button" aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" aria-expanded="false" class="{% if reduced_content %}product-item__link link text--subdued{% else %}product-item__cta button button--primary{% endif %} hidden-phone">{{ 'collection.product.quick_view' | t }}</button>
              <button type="button" {% if show_cta %}loader{% endif %} is="toggle-button" aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-popover" aria-expanded="false" class="{% if reduced_content %}product-item__link link text--subdued{% else %}product-item__cta button button--primary{% endif %} hidden-tablet-and-up">{{ 'collection.product.quick_view' | t }}</button>
    
              <quick-buy-popover id="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-popover" href="{{ product.url }}{% if product_url_contains_query %}&{% else %}?{% endif %}view=quick-buy-popover" class="popover popover--quick-buy hidden-tablet-and-up"></quick-buy-popover>
              <quick-buy-drawer id="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" href="{{ product.url }}{% if product_url_contains_query %}&{% else %}?{% endif %}view=quick-buy-drawer" class="drawer drawer--large drawer--quick-buy hidden-phone"></quick-buy-drawer>
            {%- endif -%}
          </div>
        {%- elsif reduced_content -%}
          <div class="product-item__cta-wrapper">
            <span class="product-item__link text--subdued">{{ 'collection.product.sold_out' | t }}</span>
          </div>
        {%- endif -%}  
      {% endcomment %}    
      
      
    </div>

  </div>


  





<div class="templates-collection">
  {% assign processed_ids = "" %}
  {% assign metafield_keys = "channel_variants,voltmeter_variants,custom_field_1_variants,custom_field_2_variants,color_variants" | split: "," %}

  {% for metafield_key in metafield_keys %}
    {% if product.metafields.custom[metafield_key].value != blank %}
      {% for product_main in product.metafields.custom[metafield_key].value %}

        {% unless processed_ids contains product_main.id %}
          {% assign processed_ids = processed_ids | append: product_main.id | append: "," %}
          <template id="{{ product_main.id }}" >
            {% render 'product-item-template', product: product_main, collection: collection, block: block, sizes_attribute: sizes_attribute, reveal: settings.stagger_products_apparition %}
          </template>
        {% endunless %}

        {% for sub_metafield_key in metafield_keys %}
          {% if product_main.metafields.custom[sub_metafield_key].value != blank %}
            {% for sub_product in product_main.metafields.custom[sub_metafield_key].value %}
              {% unless processed_ids contains sub_product.id %}
                {% assign processed_ids = processed_ids | append: sub_product.id | append: "," %}
                <template id="{{ sub_product.id }}" >
                  {% render 'product-item-template', product: sub_product, collection: collection, block: block, sizes_attribute: sizes_attribute, reveal: settings.stagger_products_apparition %}
                </template>
              {% endunless %}
            {% endfor %}
          {% endif %}
        {% endfor %}
        
      {% endfor %}
    {% endif %}
  {% endfor %}
</div>




  
</product-item>